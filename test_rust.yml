steps:

  - script: |
      mkdir -p ./zdevelop/tests/_reports
      mkdir -p ./reports
      cargo test -- -Z unstable-options --format json --report-time | tee ./zdevelop/tests/_reports/results.json
    displayName: cargo test

  - script: cargo install cargo-tarpaulin
    displayName: Install tarpaulin

  - script: |
      cargo tarpaulin -v
      cat ./zdevelop/tests/_reports/cobertura.xml > ./reports/coverage.xml
    displayName: Run Code Coverage

  - script: cargo install cargo2junit
    displayName: install cargo2junit

  - script: cat ./zdevelop/tests/_reports/results.json | cargo2junit > ./reports/tests_junit.xml
    displayName: Convert to JUnit Reports

  - task: PythonScript@0
    displayName: Check Coverage
    inputs:
      scriptSource: filePath
      scriptPath: '$(BUILD_SCRIPTS_DIR)/python_check_coverage.py'
      failOnStderr: true
